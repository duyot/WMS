<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head >
    <title>WMS - Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="WMS" />
    <!--CSS-->
    <link rel='stylesheet'  th:href="@{/css/bootstrap.css}"  type='text/css' />
    <link rel="stylesheet"  th:href="@{/css/bootstrap-table.css}"/>
    <link rel='stylesheet'  th:href="@{/workspace_resource/css/style.css}"  type='text/css' />
    <link rel="stylesheet"  th:href="@{/workspace_resource/css/animate.css}"  type="text/css" media="all"/>
    <link rel="stylesheet"  th:href="@{/fonts/font-awesome/css/font-awesome.min.css}"/>

    <link rel="stylesheet" th:href="@{/css/bootstrap-select.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap-toggle.css}"/>
    <!--script-->
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <script th:attr="src=@{/js/wow.min.js}"  th:href="@{/js/wow.min.js}"></script>
    <script>
        new WOW().init();
    </script>
    <script th:attr="src=@{/js/jquery-1.10.2.min.js}" th:href="@{/js/jquery-1.10.2.min.js}"></script>
    <script th:attr="src=@{/js/bootstrap-table.js}"  th:href="@{/js/bootstrap-table.js}"></script>
    <script th:attr="src=@{/js/bootstrap-select.min.js}"  th:href="@{/js/bootstrap-select.min.js}"></script>
    <!--confirmation-->
    <script th:attr="src=@{/js/bootstrap.min.js}"  th:href="@{/js/bootstrap.min.js}"></script>
    <!--common-->
    <script th:attr="src=@{/js/wms-common.js}"      th:href="@{/js/wms-common.js}"></script>
    <!--font and favi icon-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"/>
    <link rel="shortcut icon" th:href="@{/images/wms_favicon.ico}"/>

</head>
<body class="sticky-header left-side-collapsed">
<section>
    <!--left menu-->
    <div th:include="common/workspace_leftmenu :: frag-leftmenu"></div>
    <!--main content-->
    <div class="main-content main-content2 main-content2copy">
        <div th:include="common/header :: frag-headermneu"></div>
        <div id="page-wrapper">
            <!--search panel-->
            <div id="panel-search-content" class="panel panel-primary">
                <div class="panel-heading">
                    <i class="fa fa-search"></i>
                    <!--Search info-->
                </div>
                <div class="panel-body">
                    <form>
                        <div class="container">
                            <!--row 1: customer + stock-->
                            <div class="row">
                                <div class="col-sm-2">
                                    <label th:text="#{lbl.usage}"></label>
                                </div>

                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <label id="lblCustomer" th:utext="${session.selectedCustomer.name}"></label>
                                        <label id="lbl-customerId" style="display: none" th:text="${session.selectedCustomer.id}"></label>
                                        <button id="btn-check-serial" style="display: none" th:value="@{/workspace/stock_management/import/isSerial}"></button>
                                        <button id="btn-get-cells" style="display: none" th:value="@{/workspace/stock_management/import/getCells}"></button>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <label class="label-require" for="cmb-stock" th:text="#{lbl.stock}"></label>
                                </div>
                                <div class="col-sm-4">
                                    <div class="input-group" style="width: 100%;">
                                        <select id="cmb-stock" class="form-control selectpicker" data-live-search="true"  data-width="100%">
                                            <option  th:each="sopt:${lstStock}"
                                                     th:value="${sopt.id}" th:text="${sopt.name}">1</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!--row 2: contract number + invoice-->
                            <div class="row">
                                <div class="col-sm-2">
                                    <label th:text="#{lbl.contracnumber}" for="inp-contract-number"></label>
                                </div>
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                                <i class="fa fa-book fa-fw"></i>
                                            </span>
                                        <input id="inp-contract-number" class="form-control" type="text"
                                               data-validation="length" data-validation-length="max50"
                                               data-validation-error-msg="Quá số kí tự cho phép(50)"
                                        />
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <label th:text="#{lbl.invoice}" for="inp-invoice"></label>
                                </div>
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                                <i class="fa fa-table fa-fw"></i>
                                            </span>
                                        <input id="inp-invoice" class="form-control" type="text"
                                               data-validation="length" data-validation-length="max50"
                                               data-validation-error-msg="Quá số kí tự cho phép(50)"
                                        />
                                    </div>
                                </div>
                            </div>
                            <!--note-->
                            <!--row 3: note-->
                            <div class="row">
                                <div class="col-sm-2">
                                    <label th:text="#{lbl.note}" for="inp-contract-note"></label>
                                </div>
                                <div class="col-sm-10">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                                <i class="fa fa-sticky-note fa-fw"></i>
                                            </span>
                                        <textarea id="inp-contract-note" class="form-control error" th:rows="2"
                                                  data-validation="length" data-validation-length="max500"
                                                  data-validation-error-msg="Quá số kí tự cho phép(500)"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>

                            <!--row 4: file upload-->
                            <div class="row">
                                <div class="col-sm-2">
                                    <label th:text="#{lbl.fileupload}" for="btn-excel-import"></label>
                                </div>
                                <div class="col-sm-1">
                                    <div class="input-group">
                                        <button type="button" th:title="#{tooltip.uploadfile}" class="btn btn-default  btn-primary fa fa-upload"
                                                id="btn-excel-import" th:value="@{/workspace/stock_management/import/upload}">
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group">
                                            <input id="inp-file-import" data-toggle="toggle" type="file"
                                                   onchange="isValidExcel(this);"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="input-group">
                                        <a class="link-label" th:text="#{link.downloadtemplate}" th:href="@{/workspace/stock_management/import/getTemplateFile}">
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="wrapper text-center" style="text-align: center;">
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-default  btn-primary"
                                    id="btn-import" th:value="@{/workspace/stock_management/import/import}">
                                <i class="fa fa-sign-in"></i>
                                <span th:text="#{btn.import}"></span>
                            </button>

                        </div>
                    </div>

                    <p></p>

                </div>
            </div>
            <!--end search panel-->
            <div id="panel-search-result" class="panel panel-primary">
                <div class="panel-heading">
                    <i class="fa fa-database"></i>
                    <!--Result-->
                </div>
                <div class="panel-body">
                    <!--toolbar-->
                    <div id="toolbar" class="btn-group">
                        <button id="btn-add" th:value="@{/workspace/stock_management/import/add}" type="button"
                                class="btn btn-default" th:title="#{tooltip.addgoods}" >
                            <i class="fa fa-plus"></i>
                        </button>
                        <button id="btn-refresh-table" th:href="@{/workspace/stock_management/import/getFile}" type="button"
                                class="btn btn-default" th:title="#{tooltip.cleartabble}" >
                            <i class="fa  fa-refresh"></i>
                        </button>

                        <label class="toolbar-label-info" id="import-action-info"></label>
                        <label id="del-action-info"></label>
                    </div>
                    <table  id="tbl-import-goods"
                            data-pagination="true"
                            data-search="true"
                            data-click-to-select="true"
                            data-show-columns="true"
                            data-toolbar="#toolbar"
                            class="table-striped"
                            style="word-wrap: break-word;  table-layout: fixed;"
                    >

                        <thead>
                        <tr>
                            <th   data-field="id" data-formatter="runningFormatter" data-align="center" data-width="40px">STT</th>
                            <th   class="col-md-2" data-field="goodsCode" data-align="left" data-sortable="true">Mã hàng</th>
                            <th   class="col-md-2" data-field="goodsName" data-align="left" data-sortable="true">Tên hàng</th>
                            <th   data-field="goodsStateValue" data-align="left" data-sortable="true">Trạng thái</th>
                            <th   class="col-md-2" data-field="serial" data-align="left" data-sortable="true">Serial</th>
                            <th   data-field="amountValue" data-align="right" data-sortable="true">Số lượng</th>
                            <th   data-field="inputPriceValue" data-align="right" data-sortable="true">Giá nhập</th>
                            <th   data-field="cellCode" data-align="left" data-sortable="true">Vị trí</th>
                            <th   data-field="columnId" data-align="left" data-sortable="true" >ColumnId</th>
                            <th data-align="center"  data-events="operateEvents" data-formatter="operateFormatter">Thao tác</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-loading"><!-- Place at bottom of page --></div>
    <!--modal-->
    <div th:include="modal/confirm_download_modal :: frag-confirm-download-error-modal"></div>
    <div th:include="modal/confirm_download_import_error_modal :: frag-confirm-download-error-modal"></div>
    <div th:include="modal/import_stock_add_goods_modal :: frag-add-goods-modal"></div>
    <div th:include="modal/confirm_modal :: frag-confirm-modal"></div>
    <!--footer-->
    <div th:include="common/footer :: frag-footer"></div>
</section>

<!--FINAL JS-->
<script th:attr="src=@{/js/jquery.nicescroll.js}" th:href="@{/js/jquery.nicescroll.js}"></script>
<script th:attr="src=@{/js/scripts.js}" th:href="@{/js/scripts.js}"></script>
<!--switch-->
<script th:attr="src=@{/js/bootstrap-toggle.min.js}" th:href="@{/js/bootstrap-toggle.min.js}"></script>
<!--validation-->
<script th:attr="src=@{/js/jquery.form-validator.min.js}" th:href="@{/js/jquery.form-validator.min.js}"></script>
<script>
    //---------------------------------------------------------------------
    $table = $('#tbl-import-goods');
    var dataInit = [
    ];
    function operateFormatter(value, row, index) {
        return [
            '<a class="update-goods row-function" href="javascript:void(0)" title="Sửa">',
            '<i class="fa fa-pencil-square-o"></i>',
            '</a> ',
            '<a class="delete-goods row-function" href="javascript:void(0)" title="Xóa">',
            '<i class="fa fa-trash"></i>',
            '</a> '
        ].join('');
    }
    $(function () {
        //
        $table.bootstrapTable({
            data: dataInit
        });
        $table.bootstrapTable('hideColumn', 'columnId');
        $table.bootstrapTable('hideColumn', 'goodsId');
        $table.bootstrapTable('hideColumn', 'isSerial');
        //
        selectedIndex = -1;
        $table.bootstrapTable({}).on('click-row.bs.table', function (e, row, $element) {
            selectedIndex = $element.attr('data-index');
        });
        //
        disableElement($('#btn-import'));
        //
        $.validate({
            decimalSeparator : '.',
            modules : 'file'
        });
        //
        $("#myModal").on('shown.bs.modal', function () {
            $('#modal-cmb-goodsundefined').focus();
            $('#modal-cmb-goodsundefined').attr("autocomplete","off");
        });
    });

    window.operateEvents = {
        'click .update-goods': function (e, value, row, index) {
            changeModelByType(false,row);
            showModal($('#myModal'))
        },

        'click .delete-goods': function (e, value, row, index) {
            clearActionInfo();
            $table.bootstrapTable('remove', {
                field: 'columnId',
                values: row["columnId"]
            });
        }
    };
    //@Upload---------------------------------------------------------------------
    var btnUploadExcel = $('#btn-excel-import');
    $(function () {
        btnUploadExcel.click(function () {
            //
            $("#import-action-info").text('');
            //
            var data = new FormData();
            jQuery.each(jQuery('#inp-file-import')[0].files, function(i, file) {
                data.append('file-'+i, file);
            });

            var fileName = $('#inp-file-import').val();
            if(fileName == ''){
                alert('Chưa có file dữ liệu');
                return;
            }
            //
            $body.addClass("loading");
            //
            $.ajax({
                url: btnUploadExcel.val(),
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST',
                success: function(data){
                    if(data == ''){
                        $('#myDownloadErrorModal').modal('show');
                        return;
                    }
                    $table.bootstrapTable('load', data);
                    //
                    enableElement($('#btn-import'));
                },
                error: function(data){
                    alert(data);
                },
                complete: function(){
                    $body.removeClass("loading");
                }
            });
        });

    });
    //@Import---------------------------------------------------------------------
    var btnImport = $('#btn-import');
    btnImport.click(function () {
        var contractNumber = $('#inp-contract-number').val();
        if(isContainXMLCharacter(contractNumber)){
            alert("Mã hợp đồng chứa kí tự đặc biệt!");
            return;
        }
        //validate
        var import_goods = $table.bootstrapTable('getData');
        if(import_goods.length == 0){
            alert('Chưa có thông tin hàng nhập!');
            return;
        }
        var stockIdValue = $('#cmb-stock').val();
        if(stockIdValue == null){
            alert('Chưa có thông tin kho nhập!');
            $('#cmb-stockundefined').focus();
            return;
        }
        //
        $("#lbl-del-info").text('Nhập hàng lên hệ thống?');
        //
        showModal($('#myConfirmModal'));
    });

    var btnImportConfirm = $('#modal-btn-del-ok');
    $body = $("body");
    btnImportConfirm.click(function () {
        //
        hideModal($('#myConfirmModal'));
        $body.addClass("loading");
        var stockIdValue = $('#cmb-stock').val();
        var contractNumberValue = $('#inp-contract-number').val();
        var invoiceValue = $('#inp-invoice').val();
        var descriptionValue = $('#inp-contract-note').val();
        var stock_trans_info = {contractNumber:contractNumberValue,invoiceNumber:invoiceValue,stockId:stockIdValue,description:descriptionValue};
        //
        var importData = JSON.stringify({lstGoods:$table.bootstrapTable('getData'),mjrStockTransDTO:stock_trans_info});
        //
        var $lblInfo = $("#import-action-info");
        //
        $.ajax({
            url: btnImport.val(),
            data:importData,
            cache: false,
            contentType: "application/json",
            dataType: 'json',
            type: 'POST',
            success: function(data){
                //
                var resultMessage  = data['statusCode'];
                var stockTransId   = data['key'];
                var successRecords = data['success'];
                //
                if(resultMessage == "SUCCESS_WITH_ERROR"){
                    var totalRecords   = data['total'];
                    //show modal upload file
                    $("#modal-error-import-lbl-info").text('Nhập '+successRecords+'/'+totalRecords+' hàng thành công với mã giao dịch '+ stockTransId);
                    $("#modal-link-download").attr("href",$("#modal-inp-stock-trans-id").val()+"/"+ stockTransId);
                    showModal($("#myDownloadErrorImportModal"));
                }else{
                    setInfoMessage($lblInfo,"Nhập "+successRecords+" hàng thành công với mã giao dịch: "+ stockTransId)
                }
                disableElement($('#btn-import'));
                $table.bootstrapTable('removeAll');
            },
            error: function(data){
                setErrorMessage($lblInfo,JSON.stringify(data))
            },
            complete: function(){
                $body.removeClass("loading");
            }
        });
    });
    //@Add action---------------------------------------------------------------------------------------------------
    var $btnAdd = $('#btn-add');
    $(function () {
        $btnAdd.click(function () {
            changeModelByType(true,null);
            //
            var isSerial;
            var price;
            //
            $.ajax({
                url: $('#btn-check-serial').val()+'/'+$('#modal-cmb-goods').val(),
                cache: false,
                contentType: false,
                processData: false,
                async:false,
                type: 'GET',
                success: function(data){
                    isSerial = data["isSerial"];
                    price = data["inPrice"];
                },
            });
            //
            showElementBySerialType(isSerial);
            $('#modal-inp-input-price').val(price);
            $('#modal-label-inp-input-price').text(DOCSO.doc(price));
            //
            showModal($('#myModal'));
        });
    });

    function showElementBySerialType(serialType) {
        if(serialType == '1'){
            $('#modal-inp-amount').val('1');
            disableElement($('#modal-inp-amount'));
            enableElement($('#modal-inp-serial'));
        }else{
            disableElement($('#modal-inp-serial'));
            enableElement($('#modal-inp-amount'));
        }
    }
    //----------------------------------------------------------------------------------------------------------------
    $("#modal-cmb-goods").change(function () {
        var inputAmount;
        var isSerial;
        //
        $.ajax({
            url: $('#btn-check-serial').val()+'/'+$('#modal-cmb-goods').val(),
            cache: false,
            contentType: false,
            processData: false,
            async:false,
            type: 'GET',
            success: function(data){
                currentGoods = data;
                inputAmount = currentGoods['inPrice'];
                isSerial = data["isSerial"];
            },
        });
        //
        showElementBySerialType(isSerial);
        $('#modal-inp-input-price').val(inputAmount);
        $('#modal-label-inp-input-price').text(DOCSO.doc(inputAmount));
    });
    //----------------------------------------------------------------------------------------------------------------

    var $btnAddModal = $('#modal-btn-add');
    $(function () {
        $btnAddModal.click(function () {
            //
            if(isAllFieldValid($("#form-add-goods")) == false){
                alert('Nội dung nhập chứa thông tin lỗi');
                return;
            }
            //valid require serial
            var isSerial;
            var goods_code;
            //
            $.ajax({
                url: $('#btn-check-serial').val()+'/'+$('#modal-cmb-goods').val(),
                cache: false,
                contentType: false,
                processData: false,
                async:false,
                type: 'GET',
                success: function(data){
                    isSerial = data["isSerial"];
                    goods_code = data["code"];
                },
            });
            if(isSerial == '1'){
                if(($('#modal-inp-amount').val() != "1")){
                    alert(goods_code +" là hàng quản lý serial, số lượng nhập phải là 1.");
                    return;
                }
                //
                if(($('#modal-inp-serial').val().trim().length === 0)){
                    alert(goods_code +" là hàng quản lý serial, cần nhập thông tin serial.");
                    return;
                }
            }
            //pre-process data
            preprocessInput($("#form-add-goods"));
            //get data
            var goodsCode = $('#modal-cmb-goods').val();
            var goodsName = $("#modal-cmb-goods option:selected").text();
            var amount = $('#modal-inp-amount').val();
            if(amount.trim() == ""){
                return;
            }
            var goodsStateValue = "Hỏng";
            var goodsState = "0";
            if($('#cmb-goods-state').prop('checked')){
                goodsStateValue = "Bình thường";
                goodsState = "1";
            }
            var inputPriceValue = $('#modal-inp-input-price').val();
            if(inputPriceValue.trim() == ""){
                return;
            }
            var serial =   escapeHtml($('#modal-inp-serial').val());
            var cellCode = escapeHtml($('button[data-id=modal-cmb-cells]').attr('title'));
            if(cellCode.includes("selected")){
                cellCode = "";
            }
            //add to table
            var columnId = ~~(Math.random() * 100) * -1,
                rows = [];
            rows.push({
                goodsCode: goodsCode,
                goodsName: goodsName,
                goodsState: goodsState,
                goodsStateValue: goodsStateValue,
                serial:serial,
                amountValue: amount,
                amount: amount,
                inputPriceValue: inputPriceValue,
                inputPrice: inputPriceValue,
                cellCode: cellCode,
                columnId:columnId
            });
            //
            $table.bootstrapTable('append', rows);
            enableElement($('#btn-import'));
            //
        });
    });

    //@Update action---------------------------------------------------------------------------------------------------
    var $btnUpdateModal = $('#modal-btn-update');
        $btnUpdateModal.click(function () {
            //get data
            var goodsCode = $('#modal-cmb-goods').val();
            var goodsName = $("#modal-cmb-goods option:selected").text();
            var amount = $('#modal-inp-amount').val();
            var goodsStateValue = "Hỏng";
            var goodsState = "0";
            if($('#cmb-goods-state').prop('checked')){
                goodsStateValue = "Bình thường";
                goodsState = "1";
            }
            var inputPriceValue = $('#modal-inp-input-price').val();
            var serial = $('#modal-inp-serial').val();
            var cellCode = escapeHtml($('button[data-id=modal-cmb-cells]').attr('title'));
            if(cellCode.includes("selected")){
                cellCode = "";
            }

            $table.bootstrapTable('updateRow', {index:selectedIndex,row:{
                goodsCode: goodsCode,
                goodsName: goodsName,
                goodsState: goodsState,
                goodsStateValue: goodsStateValue,
                serial:serial,
                amountValue: formatFloatType(amount),
                amount: amount,
                inputPriceValue: formatFloatType(inputPriceValue),
                inputPrice: inputPriceValue,
                cellCode: cellCode
            }});
            //
            hideModal($('#myModal'));
        });
    //@Refresh table----------------------------------------------------------
    $('#btn-refresh-table').click(function () {
        $table.bootstrapTable('removeAll');
        $('#import-action-info').val("");
    });
    //-------------------------------------------------------------------------
    function changeModelByType(isAdd,selectedItems) {
        var $cmbCell = $('select[name=modalCmbCells]');
        //set cell for combo box
        $.ajax({
            url: $('#btn-get-cells').val()+'/'+$('#cmb-stock').val(),
            cache: false,
            contentType: false,
            processData: false,
            async:false,
            type: 'GET',
            success: function(data){
                if(data.length == 0){
                    disableElement($cmbCell);
                }else{
                    enableElement($cmbCell);
                }
                loadSelectItems($cmbCell,data);
            },
        });
        //
        if(isAdd){
            clearContent();
            //
            showAdd();
        }else{
            clearContent();
            $('select[name=modalCmbGoods]').val(selectedItems['goodsCode']);
            $('select[name=modalCmbGoods]').selectpicker('refresh');
            //
            $('#modal-inp-amount').val(unFormatFloat(selectedItems['amountValue']));
            if(selectedItems["goodsState"] =="1"){
                $('#cmb-goods-state').bootstrapToggle('on');
            }else{
                $('#cmb-goods-state').bootstrapToggle('off');
            }
            $('#modal-inp-input-price').val(unFormatFloat(selectedItems['inputPriceValue']));
            $('#modal-inp-serial').val(selectedItems['serial']);
            $cmbCell.val(selectedItems['cellCode']);
            //
            $('.selectpicker').selectpicker('refresh')
            showUpdate();
            //
        }
    }

    function clearContent() {
        $('#cmb-goods-state').bootstrapToggle('on');
        $('#modal-inp-input-price').val('');
        $('#modal-inp-serial').val('');
        $('select[name=modalCmbCells]').val("");
        $('#modal-inp-amount').val('');
    }

    function loadSelectItems(select, items) {
        select.empty();
        var firstValue;
        $.each(items, function(i, item) {
            var opt = document.createElement('option');
            opt.value = item.code;
            opt.innerHTML = item.code;
            select.append(opt);
        });
        select.selectpicker('refresh');
    }

    $("#modal-inp-input-price").keyup(function() {
        var currentValue = unFormatFloat($("#modal-inp-input-price").val());
        $('#modal-label-inp-input-price').text(DOCSO.doc(currentValue));
        $('#modal-inp-input-price').val(currentValue);
    });
</script>
</body>
</html>