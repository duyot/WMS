<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head >
    <title>WMS - Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="WMS" />
    <!--CSS-->
    <link rel='stylesheet' href="css/bootstrap.css" th:href="@{/css/bootstrap.css}"  type='text/css' />
    <link rel="stylesheet" href="css/bootstrap-table.css" th:href="@{/css/bootstrap-table.css}"/>
    <link rel='stylesheet' href="css/style.css" th:href="@{/workspace_resource/css/style.css}"  type='text/css' />
    <link rel="stylesheet" href="css/animate.css"  th:href="@{/workspace_resource/css/animate.css}"  type="text/css" media="all"/>
    <link rel="stylesheet" href="/fonts/font-awesome/css/font-awesome.min.css" th:href="@{/fonts/font-awesome/css/font-awesome.min.css}"/>
    <link rel="stylesheet" href="/css/nprogress.css" th:href="@{/css/nprogress.css}"/>
    <link rel="stylesheet" th:href="@{/css/bootstrap-select.min.css}"/>
    <link rel="stylesheet" href="/css/bootstrap-toggle.css" th:href="@{/css/bootstrap-toggle.css}"/>
    <!--script-->
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <!--<script th:attr="src=@{/js/wow.min.js}"  th:href="@{/js/wow.min.js}"></script>-->
    <!--<script>-->
        <!--new WOW().init();-->
    <!--</script>-->
    <script th:attr="src=@{/js/jquery-3.2.1.min.js}" th:href="@{/js/jquery-3.2.1.min.js}"></script>
    <script th:attr="src=@{/js/bootstrap-table.js}"  th:href="@{/js/bootstrap-table.js}"></script>
    <script th:attr="src=@{/js/bootstrap-select.min.js}"  th:href="@{/js/bootstrapbootstrap-select.min.js}"></script>
    <script th:attr="src=@{/js/nprogress.js}"  th:href="@{/js/nprogress.js}"></script>
    <!--confirmation-->
    <script th:attr="src=@{/js/bootstrap.min.js}"  th:href="@{/js/bootstrap.min.js}"></script>
    <script th:attr="src=@{/js/jquery.validate.min.js}"  th:href="@{/js/jquery.validate.min.js}"></script>
    <!--common-->
    <script th:attr="src=@{/js/wms-common.js}"      th:href="@{/js/wms-common.js}"></script>
    <!--font and favi icon-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"/>
    <link rel="shortcut icon" th:href="@{/images/wms_favicon.ico}"/>

</head>
<body class="sticky-header left-side-collapsed">
<section>
    <!--left menu-->
    <div th:include="common/workspace_leftmenu :: frag-leftmenu"></div>
    <!--main content-->
    <div class="main-content main-content2 main-content2copy">
        <div th:include="common/header :: frag-headermneu"></div>
        <div id="page-wrapper">
            <!--search panel-->
            <div id="panel-search-content" class="panel panel-primary">
                <div class="panel-heading">
                    <i class="fa  fa-search"></i>
                    <!--Search info-->
                </div>
                <div class="panel-body">
                    <div class="container">
                        <!--row 1: username + status-->
                        <div class="row">
                            <div class="col-sm-2">
                                <label th:text="#{lbl.usage}"></label>
                            </div>

                            <div class="col-sm-4">
                                <div class="input-group">
                                    <label id="lblCustomer" th:utext="${session.selectedCustomer.name}"></label>
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <label th:text="#{lbl.status}"></label>
                            </div>
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <input id="cmb-status" checked="true" data-toggle="toggle" data-width="110" type="checkbox" data-on="Hiệu lực" data-off="Hết hiệu lực"/>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-2">
                                <label th:text="#{lbl.goodsCode}"></label>
                            </div>

                            <div class="col-sm-4">
                                <div class="input-group">
                                    <div class="input-group">
                                                <span class="input-group-addon">
                                                    <i class="fa fa-server fa-fw"></i>
                                                </span>
                                        <input id="inp-goods-code" class="form-control" type="text"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <label th:text="#{lbl.goodsgroup}"></label>
                            </div>
                            <div class="col-sm-4">
                                <div class="input-group input-group-combo">
                                    <select id="modal-cmb-goods-group" class="combobox form-control selectpicker" data-live-search="true"
                                            data-width="100%" name="searchGoodsGroupId">
                                        <option value="-1" th:text="#{label.all}"></option>
                                        <option th:each="sopt:${mapGoodsGroup.entrySet()}"
                                                th:value="${sopt.key}" th:text="${sopt.value}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p></p>

                    <div class="wrapper text-center" style="text-align: center;">
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-default  btn-primary" id="btn-search-goods" th:value="@{/workspace/cat_goods_ctr/findByCondition}">
                                <i class="fa fa-search"></i>
                                <span th:text="#{btn.search}"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!--end search panel-->
            <div id="panel-search-result" class="panel panel-primary">
                <div class="panel-heading">
                    <i class="fa fa-database"></i>
                    <!--Result-->
                </div>
                <div class="panel-body">
                    <!--toolbar-->
                    <div id="toolbar" class="btn-group">
                        <button id="btn-add" th:title="#{btn.add}" th:value="@{/workspace/cat_goods_ctr/add}" type="button" class="btn btn-default">
                            <i class="fa fa-plus"></i>
                        </button>
                        <button id="btn-update" th:value="@{/workspace/cat_goods_ctr/update}" type="button" class="btn btn-default btn-hide">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button id="btn-delete" th:value="@{/workspace/cat_goods_ctr/delete}" type="button" class="btn btn-default btn-hide">
                            <i class="fa fa-trash"></i>
                        </button>
                        <button id="btn-show-modal-add-goods" type="button" class="btn btn-default">
                            <i class="fa  fa-upload"></i>
                        </button>

                        <label class="action-info" id="action-info"></label>
                        <label id="del-action-info"></label>
                    </div>
                    <table  id="table-pagination"
                            data-pagination="true"
                            data-search="true"
                            data-click-to-select="true"
                            data-toolbar="#toolbar"
                            class="table-striped"
                    >

                        <thead>
                        <tr>
                            <th  data-formatter="runningFormatter" data-align="center" data-width="40px">STT</th>
                            <th  class="col-md-2" data-field="code" data-align="left" data-sortable="true" th:text="#{lbl.goodsCode}"></th>
                            <th  class="col-md-3" data-field="name" data-align="left" data-sortable="true" th:text="#{lbl.goodsName}"></th>
                            <th   data-field="unitTypeName" data-align="left" data-sortable="true" th:text="#{lbl.goodsUnit}"></th>
                            <th   data-field="goodsGroupName" data-align="left" data-sortable="true" th:text="#{lbl.goodsgroup}"></th>
                            <th   data-field="isSerialName" data-align="left" data-sortable="true" th:text="#{lbl.isSerial}" ></th>
                            <th  data-field="statusName" data-align="left" data-sortable="true" th:text="#{lbl.status}"></th>
                            <th   data-field="inPriceValue" data-align="right" data-sortable="true" th:text="#{lbl.inputPrice}"></th>
                            <th   data-field="outPriceValue" data-align="right" data-sortable="true" th:text="#{lbl.outputPrice}"></th>
                            <th data-align="center"  data-events="operateEvents" data-formatter="operateFormatter" th:text="#{lbl.action}"></th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-loading"><!-- Place at bottom of page --></div>
    <!--modal-->
    <div th:include="modal/confirm_download_import_error_modal :: frag-confirm-download-error-modal"></div>
    <div th:include="modal/add_goods_modal :: frag-add-goods-modal"></div>
    <div th:include="modal/cat_goods_modal :: frag-cat-goods-modal"></div>
    <div th:include="modal/confirm_modal :: frag-confirm-modal"></div>
    <!--footer-->
    <div th:include="common/footer :: frag-footer"></div>
</section>

<!--FINAL JS-->
<script th:attr="src=@{/js/jquery.nicescroll.js}" th:href="@{/js/jquery.nicescroll.js}"></script>
<script th:attr="src=@{/js/scripts.js}" th:href="@{/js/scripts.js}"></script>
<!--switch-->
<script th:attr="src=@{/js/bootstrap-toggle.min.js}" th:href="@{/js/bootstrap-toggle.min.js}"></script>
<script>
    //
    function runningFormatter(value, row, index) {
        return index +1;
    }
    //		init empty data
    var dataInit = [
    ];
    //
    function operateFormatter(value, row, index) {
        return [
            '<a class="update-goods row-function" href="javascript:void(0)" title="Sửa">',
            '<i class="fa fa-pencil-square-o"></i>',
            '</a> ',
            '<a class="delete-goods row-function" href="javascript:void(0)" title="Xóa">',
            '<i class="fa fa-trash"></i>',
            '</a> '
        ].join('');
    }
    //
    $table = $('#table-pagination');
    $tableAddListGoods = $('#modal-tbl-add-goods');
    $body = $("body");
    $btn_update = $('#btn-update');
    var $btnDelConfirmed = $('#modal-btn-del-ok');
    var $btnDel = $('#btn-delete');
    var validator;
    //@Init component-----------------------------------------------------------------------------------------------
    $(function () {
        $table.bootstrapTable({
            data: dataInit
        });

        $tableAddListGoods.bootstrapTable({
            data: dataInit,
            pageList:[5,10, 25, 50],
            pageSize:10
        });

        search(false);
    });
    //@FUNCTION-----------------------------------------------------------------------------------------------
    var deletedItem;
    var deletedItemCode;
    window.operateEvents = {
        'click .update-goods': function (e, value, row, index) {
            validator.resetForm();
            $("#cat-goods-insert-update-form").find(".error").removeClass("error");
            //
            clearActionInfo();
            changeModelByType(2,row,$btn_update.val());
            showModal($modalAddUpdate);
            $modalAddUpdate.on('shown.bs.modal', function () {
                $('#modal-inp-code').focus();
            });
        },

        'click .delete-goods': function (e, value, row, index) {
            clearActionInfo();
            $("#lbl-del-info").text('Xóa thông tin: '+ decodeHtml(row['name']));
            $('#myConfirmModal').modal('show');

            deletedItem     = row['id'];
            deletedItemCode = row['code'];
        }
    };

    $btnDelConfirmed.click(function () {
        $.ajax({
            type: "POST",
            cache:false,
            data:{id:deletedItem,code:deletedItemCode},
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            url: $btnDel.val(),
            dataType: 'text',
            timeout: 600000,
            success: function (data) {
                var resultArr = data.split('|');
                var resultCode = resultArr[0];
                var resultName = resultArr[1];
                if(resultCode == 1){
                    setInfoMessage($('#action-info'),resultName);
                }else{
                    setErrorMessage($('#action-info'),resultName);
                }
                search(false);
            },
            error:function(){
                setErrorMessage($('#action-info'),'Lỗi hệ thống');
            }
        });
        //
        hideModal($('#myConfirmModal'));
        //
    });
    //
    function search(isClear){
        //
        NProgress.start();
        //
        if(isClear){
            clearActionInfo()
        }
        var statusVal;
        if($('#cmb-status').prop('checked')){
            statusVal = '1';
        }else{
            statusVal = '0';
        }
        var goodsCodeVal = $('#inp-goods-code').val().trim();
        var goodsGroupIdVal = $('select[name=searchGoodsGroupId]').val();
        $.ajax({
            type: "GET",
            cache:false,
            data:{status:statusVal,goodsCode:goodsCodeVal,goodsGroupId:goodsGroupIdVal},
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            url: $btnSearch.val(),
            dataType: 'json',
            timeout: 600000,
            success: function (data) {
                $table.bootstrapTable('load', data);
            },
            complete: function () {
                NProgress.done();
            }
        });
    }
    //@Upload---------------------------------------------------------------------
    var btnShowUploadModal = $('#btn-show-modal-add-goods');
    btnShowUploadModal.click(function () {
        disableElement($('#modal-btn-save-goods'));
        hideElement($('#link-upload-goods-error'));
        showModal($('#add-goods-modal'));
    });
    //
    var btnUploadExcel = $('#modal-btn-upload-excel');
    btnUploadExcel.click(function () {
        //
        $("#main-action-info").text('');
        //
        var data = new FormData();
        jQuery.each(jQuery('#inp-file-import')[0].files, function(i, file) {
            data.append('file-'+i, file);
        });

        var fileName = $('#inp-file-import').val();
        if(fileName == ''){
            alert('Chưa có file dữ liệu');
            return;
        }
        $.ajax({
            url: btnUploadExcel.val(),
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(data){
                if(data == ''){
                    //
                    showElement($('#link-upload-goods-error'));
                    $tableAddListGoods.bootstrapTable('refresh');
                    clearFileInput('inp-file-import');
                    //
                    return;
                }
                hideElement($('#link-upload-goods-error'));
                clearFileInput('inp-file-import');
                $tableAddListGoods.bootstrapTable('load', data);
                //
                enableElement($('#modal-btn-save-goods'));
            }
        });
    });
    //
    var btnSaveGoods = $('#modal-btn-save-goods');
    btnSaveGoods.click(function () {
        //validate
        var import_goods = $tableAddListGoods.bootstrapTable('getData');
        if(import_goods.length == 0){
            alert('Chưa có thông tin hàng!');
            return;
        }
        //
        var goodsData = JSON.stringify({lstGoods:$tableAddListGoods.bootstrapTable('getData')});
        $.ajax({
            url: btnSaveGoods.val(),
            data:goodsData,
            cache: false,
            contentType: "application/json",
            dataType: 'json',
            type: 'POST',
            success: function(data){
                //
                var resultMessage  = data['statusCode'];
                var successRecords = data['success'];
                //
                if(resultMessage == "SUCCESS_WITH_ERROR"){
                    var totalRecords   = data['totalMoney'];
                    //show modal upload file
                    setInfoMessage($('#modal-error-import-lbl-info'),'Nhập '+successRecords+'/'+totalRecords+' hàng thành công');
                    hideModal($('#add-goods-modal'));
                    //
                    $("#modal-link-download").attr("href",$("#modal-inp-download-save-goods-error").val());
                    showModal($("#myDownloadErrorImportModal"));
                }else{
                    setInfoMessage($("#action-info"),"Nhập "+successRecords+" hàng thành công");
                }
                //process form
                disableElement($('#modal-btn-save-goods'));
                refreshTable($tableAddListGoods);
                //
                hideModal($('#add-goods-modal'));
                search(false);
            }
        });
    });
    //@SEARCH ACTION----------------------------------------------------------------------------------------------------
    //for enter press ->
    $('#inp-goods-code').keypress(function (e) {
        var key = e.which;
        if(key == 13)  // the enter key code
        {
            search(true);
        }
    });
    //
    var $btnSearch = $('#btn-search-goods');
    $btnSearch.click(function () {
        search(true);
    });
    //@Add action---------------------------------------------------------------------------------------------------
    $btn_add = $('#btn-add');
    $modalAddUpdate = $('#myModal');
    $btn_add.click(function () {
        clearActionInfo();
        changeModelByType(1,null,$btn_add.val());
        showModal($modalAddUpdate);
        $modalAddUpdate.on('shown.bs.modal', function () {
            $('#modal-inp-code').focus();
        });
    });
    //------------------------------------------------------------------------------------------------
    $(document).ready(function () {
        validator = $("#cat-goods-insert-update-form").validate({
            ignore: ":hidden",
            rules: {
                code: {
                    required: true,
                    normalizer: function( value ) {
                        return $.trim( value );
                    },
                    maxlength: 50
                },
                name: {
                    required: true,
                    normalizer: function( value ) {
                        return $.trim( value );
                    },
                    maxlength: 100
                },
                unitType: {
                    required: true
                },
                goodsGroupId: {
                    required: true
                },
                inPrice: {
//                    required: true,
                    normalizer: function( value ) {
                        return $.trim( value );
                    },
                    number: true
                },
                outPrice: {
//                    required: true,
                    normalizer: function( value ) {
                        return $.trim( value );
                    },
                    number: true
                }
            },
            submitHandler: function (form) {
                preprocessInput($("#cat-goods-insert-update-form"));
                //
                if (isContainSpecialCharacter($('#modal-inp-code').val())) {
                    alert("Mã hàng chứa kí tự đặc biệt. Vui lòng loại bỏ kí tự (lớn hơn, nhỏ hơn)");
                    return;
                }
                if (isContainSpecialCharacter($('#modal-inp-name').val())) {
                    alert("Tên hàng chứa kí tự đặc biệt. Vui lòng loại bỏ kí tự (lớn hơn, nhỏ hơn)");
                    return;
                }
                //
                $.ajax({
                    type: "POST",
                    url: $("#cat-goods-insert-update-form").attr('action'),
                    data: $(form).serialize(),
                    success: function (data) {
                        resultArr = data.split('|');
                        resultCode = resultArr[0];
                        resultName = resultArr[1];
                        if(resultCode == 1){
                            setInfoMessage($('#action-info'),resultName);
                        }else{
                            setErrorMessage($('#action-info'),resultName);
                        }

                        search(false);

                    },
                    error:function(){
                        setErrorMessage($('#action-info'),'Lỗi hệ thống');
                    }
                });
                //
                hideModal($modalAddUpdate);
                return false; // required to block normal submit since you used ajax
            }
        });
    });
    //

    function changeModelByType(type,selectedItem,actionVal) {
        $("#cat-goods-insert-update-form").attr("th:object",actionVal);
        if(type == 1){//add

            $("#cat-goods-insert-update-form").attr("action",actionVal);
            $("#modal-inp-code").val('');
            $("#modal-inp-name").val('');
            $("#modal-inp-id").val('');
            ///
            $('select[name=unitType]').val($('#modal-cmb-goods-unit option:first ').val());
            $('select[name=goodsGroupId]').val($('#modal-cmb-goods-group option:first ').val());
            $('select[name=unitType]').selectpicker('refresh');
            $('select[name=goodsGroupId]').selectpicker('refresh');
            //
            $("#modal-inp-input-price").val('');
            $("#modal-inp-output-price").val('');
            $('#modal-label-input-price').text("");
            $('#modal-label-output-price').text("");

            $('#modal-cmb-status').bootstrapToggle('on');
            $('#modal-cmb-serial').bootstrapToggle('off');
            disableElement($('#modal-cmb-status'));
            showAdd();
        }else{//update
            $("#cat-goods-insert-update-form").attr("action",actionVal);
            $("#modal-inp-code").val(decodeHtml(selectedItem["code"]));
            $("#modal-inp-name").val(decodeHtml(selectedItem["name"]));
            $("#modal-inp-id").val(selectedItem["id"]);
            //
            $('select[name=unitType]').val(selectedItem['unitType']);
            $('select[name=unitType]').selectpicker('refresh');
            $('select[name=goodsGroupId]').val(selectedItem['goodsGroupId']);
            $('select[name=goodsGroupId]').selectpicker('refresh');
            //
            var originInput = Number((selectedItem["inPrice"]));
            var originInputStr = originInput + "";
            if(!originInputStr.includes(".")){
                $("#modal-inp-input-price").val(formatFloatType(originInputStr));
                $('#modal-label-input-price').text(DOCSO.doc(selectedItem["inPrice"]));
            }else{
                $("#modal-inp-input-price").val(originInput);
                $('#modal-label-input-price').text("");
            }
            //
            var originOutput = Number((selectedItem["outPrice"]));
            var originOutputStr = originOutput + "";
            if(!originOutputStr.includes(".")){
                $("#modal-inp-output-price").val(formatFloatType(originOutputStr));
                $('#modal-label-output-price').text(DOCSO.doc(selectedItem["outPrice"]));
            }else{
                $("#modal-inp-output-price").val(originOutput);
                $('#modal-label-output-price').text("");
            }
            //
            var currentStatus = selectedItem["status"];
            if(currentStatus == '0'){
                $('#modal-cmb-status').bootstrapToggle('off');
            }else{
                $('#modal-cmb-status').bootstrapToggle('on');
            }
            //
            var isSerial = selectedItem["isSerial"];
            if(isSerial == '0'){
                $('#modal-cmb-serial').bootstrapToggle('off');
            }else{
                $('#modal-cmb-serial').bootstrapToggle('on');
            }
            enableElement($('#modal-cmb-status'));
            showUpdate();
        }
    }

    $("#modal-inp-input-price").keyup(function() {
        var currentValue = unFormatFloat($("#modal-inp-input-price").val());
        var need2format = currentValue;
        if(!isValidPrice(currentValue)){
            currentValue = need2format.substr(0,need2format.indexOf(".") + 5);
        }
        if(!currentValue.includes(".")){
            $('#modal-label-input-price').text(DOCSO.doc(currentValue));
            $('#modal-inp-input-price').val(formatFloatType(currentValue));
        }else{
            $('#modal-inp-input-price').val(currentValue);
            $('#modal-label-input-price').text("");
        }
    });

    $("#modal-inp-output-price").keyup(function() {
        var currentValue = unFormatFloat($("#modal-inp-output-price").val());
        var need2format = currentValue;
        if(!isValidPrice(currentValue)){
            currentValue = need2format.substr(0,need2format.indexOf(".") + 5);
        }
        if(!currentValue.includes(".")){
            $('#modal-label-output-price').text(DOCSO.doc(currentValue));
            $('#modal-inp-output-price').val(formatFloatType(currentValue));
        }else{
            $('#modal-label-output-price').text("");
            $('#modal-inp-output-price').val(currentValue);
        }
    });
</script>
</body>
</html>